import"./cc-grafana-info-afd88dbc.js";import{L as n,c as a,u as i}from"./cc-smart-container-0c093be7.js";import{r,h as e,i as s,j as o}from"./api-helpers-a710dc87.js";import{s as t}from"./send-to-api-d26c0c41.js";import{d as g}from"./smart-manager-10eab692.js";import{a as l}from"./utils-e732f1fc.js";import{w as f}from"./withLatestFrom-81917e03.js";import{m as c}from"./merge-d357dbf8.js";g({selector:"cc-grafana-info",params:{apiConfig:{type:Object},ownerId:{type:String},grafanaBaseLink:{type:String}},onConnect(s,g,d,b){const w=new n,m=new n,h=a(g,"cc-grafana-info:reset").pipe(f(d)),C=a(g,"cc-grafana-info:disable").pipe(f(d)),k=a(g,"cc-grafana-info:enable").pipe(f(d)),I=c(w.error$,m.error$);i(b,[I.subscribe(console.error),I.subscribe((n=>{g.error=n.type,g.waiting=!1})),w.value$.subscribe((n=>{g.status=n.status,"enabled"===g.status&&null==n.link?g.error="link-grafana":g.link=n.link,g.waiting=!1})),m.value$.subscribe((()=>{g.waiting=!1})),h.subscribe((([n,{apiConfig:a,ownerId:i}])=>{g.error=!1,g.waiting="resetting",null!=a&&null!=i?m.push((n=>function({apiConfig:n,signal:a,ownerId:i}){return r({id:i}).then(t({apiConfig:n,signal:a})).catch(l("resetting"))}({apiConfig:a,signal:n,ownerId:i}))):g.error="resetting"})),C.subscribe((([n,{apiConfig:a,ownerId:i}])=>{g.error=!1,g.waiting="disabling",null!=a&&null!=i?w.push((n=>function({apiConfig:n,signal:a,ownerId:i}){return e({id:i}).then(t({apiConfig:n,signal:a})).then((()=>u)).catch(l("disabling"))}({apiConfig:a,signal:n,ownerId:i}))):g.error="disabling"})),k.subscribe((([n,{apiConfig:a,ownerId:i,grafanaBaseLink:r}])=>{g.error=!1,g.waiting="enabling",null!=a&&null!=i&&null!=r?w.push((n=>async function({apiConfig:n,signal:a,ownerId:i,grafanaBaseLink:r}){return await o({id:i}).then(t({apiConfig:n,signal:a})).catch(l("enabling")),await p({apiConfig:n,signal:a,ownerId:i,grafanaBaseLink:r})}({apiConfig:a,signal:n,ownerId:i,grafanaBaseLink:r}))):g.error="enabling"})),d.subscribe((({apiConfig:n,ownerId:a,grafanaBaseLink:i})=>{g.error=!1,g.link=null,g.status=null,g.waiting=!1,null!=n&&null!=a&&null!=i&&w.push((r=>p({apiConfig:n,signal:r,ownerId:a,grafanaBaseLink:i})))}))])}});const u={status:"disabled",link:null};function p({apiConfig:n,signal:a,ownerId:i,grafanaBaseLink:r}){return s({id:i}).then(t({apiConfig:n,signal:a})).then((n=>{const a=new URL("/d/home/clever-cloud-metrics-home",r);return a.searchParams.set("orgId",n.id),{status:"enabled",link:a.toString()}})).catch((n=>{if(404===n.response?.status&&n.toString().startsWith("Error: Grafana organization not found"))return u;throw n})).catch(l("loading"))}
